<p-dialog header="Editar Usuario"
            [(visible)]="isModalOpen"
            [modal]="true"
            [style]="{width: '650px', minWidth: '400px'}"
            (onShow)="onModalShow()"
            (onHide)="hideDialog()"
            position="center"
            [contentStyle]="{'overflow-y': 'auto', 'max-height': '85vh'}">

  <form [formGroup]="userForm" (ngSubmit)="onSubmit()" *ngIf="userStore.selectedUser() as selectedUser">
    <div class="p-fluid grid gap-x-4 gap-y-3 px-1">

      <div class="field col-12 md:col-6">
        <label for="edit-user-nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo <span class="text-red-500">*</span></label>
        <input id="edit-user-nombre" type="text" pInputText formControlName="nombre" class="w-full" autofocus>
        <small *ngIf="userForm.controls['nombre']?.touched && userForm.controls['nombre']?.errors?.['required']" class="p-error block">Nombre es requerido.</small>
        <small *ngIf="userForm.controls['nombre']?.touched && userForm.controls['nombre']?.errors?.['maxlength']" class="p-error block">Máx. 255 caracteres.</small>
      </div>

      <div class="field col-12 md:col-6">
        <label for="edit-user-email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico <span class="text-red-500">*</span></label>
        <input id="edit-user-email" type="email" pInputText formControlName="email" class="w-full">
        <small *ngIf="userForm.controls['email']?.touched && userForm.controls['email']?.errors?.['required']" class="p-error block">Email es requerido.</small>
        <small *ngIf="userForm.controls['email']?.touched && userForm.controls['email']?.errors?.['email']" class="p-error block">Email inválido.</small>
        <small *ngIf="userForm.controls['email']?.touched && userForm.controls['email']?.errors?.['maxlength']" class="p-error block">Máx. 255 caracteres.</small>
      </div>

      <div class="field col-12 md:col-6">
        <label for="edit-user-sucursal" class="block text-sm font-medium text-gray-700 mb-1">Sucursal <span class="text-red-500">*</span></label>
        <p-dropdown id="edit-user-sucursal"
                    [options]="sucursalStore.sucursales()"
                    formControlName="sucursal_id"
                    placeholder="Seleccionar sucursal"
                    optionLabel="nombre"
                    optionValue="id"
                    [filter]="true" filterBy="nombre" [showClear]="true"
                    appendTo="body" styleClass="w-full" scrollHeight="180px">
          <ng-template pTemplate="emptyfilter">No se encontraron sucursales.</ng-template>
          <ng-template pTemplate="empty">No hay sucursales disponibles.</ng-template>
        </p-dropdown>
        <small *ngIf="userForm.controls['sucursal_id']?.touched && userForm.controls['sucursal_id']?.errors?.['required']" class="p-error block">Sucursal es requerida.</small>
      </div>

      <div class="field col-12 md:col-6">
        <label for="edit-user-rol" class="block text-sm font-medium text-gray-700 mb-1">Rol <span class="text-red-500">*</span></label>
        <p-dropdown id="edit-user-rol"
                    [options]="roleStore.roles()"
                    formControlName="role_id"
                    placeholder="Seleccionar rol"
                    optionLabel="name" optionValue="id"
                    [filter]="true" filterBy="name" [showClear]="true"
                    appendTo="body" styleClass="w-full" scrollHeight="180px">
          <ng-template pTemplate="emptyfilter">No se encontraron roles.</ng-template>
          <ng-template pTemplate="empty">No hay roles disponibles.</ng-template>
        </p-dropdown>
        <small *ngIf="userForm.controls['role_id']?.touched && userForm.controls['role_id']?.errors?.['required']" class="p-error block">Rol es requerido.</small>
      </div>

      <div class="field col-12 flex items-center pt-2">
        <p-checkbox formControlName="estado" [binary]="true" inputId="edit-user-estado"></p-checkbox>
        <label for="edit-user-estado" class="ml-2 text-sm font-medium text-gray-700">Usuario Activo</label>
      </div>

    </div>

      <div class="flex justify-end space-x-2 pt-4 mt-4 border-t border-gray-200">
        <p-button label="Cancelar" icon="pi pi-times" styleClass="p-button-text" (click)="hideDialog()"></p-button>
        <p-button label="Guardar Cambios" icon="pi pi-save" type="submit" styleClass="p-button-success" [disabled]="userForm.invalid && !userForm.dirty"></p-button>
      </div>
  </form>
  <ng-template [ngIf]="!userStore.selectedUser() && isModalOpen">
      <p class="p-4 text-center">No hay un usuario seleccionado para editar o se está cargando.</p>
  </ng-template>
</p-dialog>
